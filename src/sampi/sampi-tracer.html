<link rel='import' href='/components/polymer/polymer.html'>
<link rel='import' href='/components/paper-button/paper-button.html'>

<script src='/components/requirejs/require.js'></script>
<script>
require(['/js/importer.js', '/js/renderer.js']);
</script>

<dom-module id='sampi-tracer'>
  <template>
    <style>
    :host { display: block; }

    paper-button {
      background-color: green;
      color: white;
    }
    textarea { margin: 10px; }
    img {
      margin: 10px;
      border: 1px solid #aaa;
    }
    canvas { display: none; }
    </style>

    <div class='layout horizontal'>
      <div class='layout vertical'>
        <textarea id='text' rows='40' cols='100'>
          {"width": 200, "height": 200}
        </textarea>
        <paper-button raised on-click='trace'>trace</paper-button>
      </div>

      <div class='layout vertical start flex'>
        <span id='status'></span>

        <img src='' id='img' width='500' height='500'>
        <canvas id='canvas' width='500' height='500'></canvas>
      </div>
    </div>
  </template>

  <script>
  'use strict';

  Polymer({
    is: 'sampi-tracer',

    ctx_: undefined,
    width_: 500,
    height_: 500,

    ready: function() {
      this.updateSizes_();

      this.ctx_ = this.$.canvas.getContext('2d');
      this.ctx_.fillStyle = 'white';
      this.ctx_.fillRect(0, 0, 500, 500);
    },

    updateSizes_: function() {
      let canvas = this.$.canvas;
      canvas.width = this.width_;
      canvas.height = this.height_;

      canvas.style.width = this.width_ + 'px';
      canvas.style.height = this.height_ + 'px';

      let img = this.$.img;
      img.style.width = this.width_ + 'px';
      img.style.height = this.height_ + 'px';
    },

    trace: function() {
      this.$.status.textContent = 'rendering ...';

      let scene = Importer.importScene(this.$.text.value);
      this.width_ = scene.width();
      this.height_ = scene.height();
      this.updateSizes_();

      let renderer = Renderer.createRenderer(scene);
      let imageData = this.ctx_.getImageData(0, 0, this.width_, this.height_);

      renderer.render(imageData, () => {
          this.$.img.src = this.$.canvas.toDataURL('image/png');
        })
        .then((msg) => {
          this.$.img.src = this.$.canvas.toDataURL('image/png');
          this.$.status.textContent = 'render complete';
        })
        .catch((reason) => {
          this.$.status.textContent = 'render error: ' + reason;
        });
    }
  });
  </script>
</dom-module>

